# Comprehensive SAST and SCA Security Scanning Pipeline for TiXL
# TIXL-058: Enhanced security scanning with quality gates and reporting

name: TiXL Comprehensive Security Scanning

on:
  push:
    branches: [ main, develop, security-* ]
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]
  schedule:
    - cron: '0 6 * * *'  # Daily comprehensive scan at 6 AM UTC
    - cron: '0 18 * * 1'  # Weekly deep scan on Monday at 6 PM UTC
  workflow_dispatch:
    inputs:
      scanType:
        description: 'Type of security scan to perform'
        required: true
        default: 'comprehensive'
        type: choice
        options:
          - quick
          - comprehensive
          - deep
      severityThreshold:
        description: 'Minimum severity to fail build'
        required: true
        default: 'medium'
        type: choice
        options:
          - low
          - medium
          - high
          - critical

env:
  DOTNET_VERSION: '9.0.x'
  JAVA_VERSION: '17'
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'

jobs:
  # Pre-scan Environment Setup
  environment-setup:
    name: Setup Security Scanning Environment
    runs-on: ubuntu-latest
    outputs:
      scan-id: ${{ steps.generate-scan-id.outputs.scan-id }}
    steps:
      - name: Generate Scan ID
        id: generate-scan-id
        run: echo "scan-id=$(date +%Y%m%d-%H%M%S)-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

  # === SAST (Static Application Security Testing) ===
  
  # Enhanced CodeQL Analysis
  sast-codeql:
    name: Enhanced CodeQL Security Analysis
    runs-on: ubuntu-latest
    needs: environment-setup
    permissions:
      actions: read
      contents: read
      security-events: write
      pull-requests: write
    strategy:
      fail-fast: false
      matrix:
        language: [ 'csharp' ]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          config-file: .github/codeql/codeql-config.yml
          queries: security-extended,security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{matrix.language}}"
          output-format: sarifv2.1.0

      - name: Upload CodeQL results to GitHub
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif
          category: "codeql-analysis"
        continue-on-error: true

      - name: Store CodeQL results for analysis
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: codeql-results-${{ needs.environment-setup.outputs.scan-id }}
          path: |
            results.sarif
            codeql-database/**
          retention-days: 90

  # SonarQube SAST Analysis
  sast-sonarqube:
    name: SonarQube SAST Analysis
    runs-on: ubuntu-latest
    needs: environment-setup
    env:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install SonarScanner for .NET
        run: dotnet tool install --global dotnet-sonarscanner

      - name: Run SonarCloud analysis
        run: |
          dotnet sonarscanner begin \
            /k:"tixl-security-sast" \
            /o:"tixl-org" \
            /d:sonar.token="${{ secrets.SONAR_TOKEN }}" \
            /d:sonar.host.url="${{ secrets.SONAR_HOST_URL }}" \
            /d:sonar.cs.vscoveragexml.reportsPaths="**/*.coveragexml" \
            /d:sonar.cs.xunit.reportsPaths="**/TestResults/*.xml" \
            /d:sonar.scm.provider=git \
            /d:sonar.qualitygate.wait=true

      - name: Build and analyze
        run: |
          dotnet restore
          dotnet build --configuration Release --no-restore
          dotnet sonarscanner end /d:sonar.token="${{ secrets.SONAR_TOKEN }}"

      - name: Upload SonarCloud results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sonarqube-results-${{ needs.environment-setup.outputs.scan-id }}
          path: |
            .sonarqube/**
          retention-days: 90

  # Semgrep SAST Analysis
  sast-semgrep:
    name: Semgrep SAST Analysis
    runs-on: ubuntu-latest
    needs: environment-setup
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Semgrep
        uses: semgrep/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/secrets
            p/owasp-top-ten
            p/dotnet
          generateSarif: "1"
          output: semgrep.sarif
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

      - name: Upload Semgrep results
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif
          category: "semgrep-sast"
        continue-on-error: true

      - name: Upload Semgrep results as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-results-${{ needs.environment-setup.outputs.scan-id }}
          path: |
            semgrep.sarif
          retention-days: 90

  # === SCA (Software Composition Analysis) ===

  # Enhanced NuGet and Dependency Scanning
  sca-nuget:
    name: NuGet and .NET Dependency Analysis
    runs-on: ubuntu-latest
    needs: environment-setup
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install dotnet-retire
        run: dotnet tool install --global dotnet-retire --version 3.1.0

      - name: Install OWASP Dependency-Check
        run: |
          wget https://github.com/jeremylong/DependencyCheck/releases/download/v10.0.2/dependency-check-10.0.2-release.zip
          unzip dependency-check-10.0.2-release.zip
          chmod +x dependency-check/bin/dependency-check.sh

      - name: Install Syft and Grype (SCA Scanner)
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin

      - name: Restore NuGet packages
        run: dotnet restore --verbosity minimal

      - name: Run dotnet-retire
        run: dotnet retire --ignore-urls "https://localhost/**" --output-format json --output retire-results.json

      - name: Run NuGet audit
        run: |
          dotnet list package --vulnerable --include-transitive --format json > nuget-audit.json || true
          dotnet list package --deprecated --include-transitive --format json > nuget-deprecated.json || true
          dotnet list package --outdated --include-transitive --format json > nuget-outdated.json || true

      - name: Run OWASP Dependency Check
        run: |
          mkdir -p dependency-check-results
          ./dependency-check/bin/dependency-check.sh \
            --project "TiXL" \
            --scan "*.csproj" \
            --format "JSON,HTML,CSV,SARIF" \
            --out "dependency-check-results" \
            --enableRetired \
            --enableExperimental \
            --enableHint \
            --enableOssIndex \
            --cveValidForHours 24
          
          # Scan compiled binaries if available
          if [ -d "bin" ]; then
            ./dependency-check/bin/dependency-check.sh \
              --project "TiXL-Binaries" \
              --scan "bin/" \
              --format "JSON,HTML,CSV,SARIF" \
              --out "dependency-check-results" \
              --enableRetired \
              --enableExperimental
          fi

      - name: Run Syft SBOM Generation
        run: |
          syft . -o json > sbom-cyclonedx.json
          syft . -o spdx-json > sbom-spdx.json
          syft . -o github-json > sbom-github.json

      - name: Run Grype Vulnerability Scanning
        run: |
          grype . -o json > grype-results.json
          grype . -o sarif > grype-results.sarif

      - name: Upload SCA results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sca-results-${{ needs.environment-setup.outputs.scan-id }}
          path: |
            **/*.json
            **/*.sarif
            **/*.html
            **/*.csv
            sbom-*.json
          retention-days: 90

      - name: Upload Grype results to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: grype-results.sarif
          category: "grype-sca"
        continue-on-error: true

  # GitHub Dependency Graph and Dependabot
  sca-dependencies:
    name: GitHub Dependency Graph Analysis
    runs-on: ubuntu-latest
    needs: environment-setup
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore

      - name: Analyze dependency tree
        run: |
          dotnet list package --include-transitive --format tree > dependency-tree.txt
          dotnet list package --vulnerable --include-transitive || true > vulnerabilities.txt
          dotnet list package --deprecated --include-transitive || true > deprecated.txt

      - name: Check for known security advisories
        run: |
          curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
               -H "Accept: application/vnd.github.v3+json" \
               "https://api.github.com/repos/${{ github.repository }}/vulnerability-alerts" > alerts.json || true

      - name: Upload dependency analysis results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-analysis-${{ needs.environment-setup.outputs.scan-id }}
          path: |
            dependency-tree.txt
            vulnerabilities.txt
            deprecated.txt
            alerts.json
          retention-days: 90

  # === SECRET AND CREDENTIAL SCANNING ===

  secret-scanning:
    name: Comprehensive Secret Scanning
    runs-on: ubuntu-latest
    needs: environment-setup
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified

      - name: Run GitLeaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

      - name: Run GitHub Secret Scanner
        uses: github/secret-scanning-action@v1
        with:
          pat-references: main

      - name: Upload secret scanning results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: secret-scanning-${{ needs.environment-setup.outputs.scan-id }}
          path: |
            trufflehog-*.json
            gitleaks-*.json
          retention-days: 90

  # === CONTAINER SECURITY (if Dockerfiles exist) ===
  container-security:
    name: Container Security Scanning
    runs-on: ubuntu-latest
    needs: environment-setup
    if: hashFiles('**/Dockerfile*') != ''
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
          category: "trivy-container-security"
        continue-on-error: true

      - name: Upload container security results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: container-security-${{ needs.environment-setup.outputs.scan-id }}
          path: |
            trivy-results.sarif
          retention-days: 90

  # === INFRASTRUCTURE AS CODE SECURITY ===
  iac-security:
    name: Infrastructure as Code Security
    runs-on: ubuntu-latest
    needs: environment-setup
    if: hashFiles('**/*.tf*', '**/*.yaml', '**/*.yml', '**/kubernetes/*.yaml') != ''
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Checkov
        id: checkov
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          framework: all
          output_format_path: 'checkov.sarif'

      - name: Upload Checkov results
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'checkov.sarif'
          category: "checkov-iac-security"
        continue-on-error: true

      - name: Upload IaC security results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: iac-security-${{ needs.environment-setup.outputs.scan-id }}
          path: |
            checkov.sarif
          retention-days: 90

  # === VULNERABILITY TRIAGE AND ANALYSIS ===
  vulnerability-triage:
    name: Vulnerability Triage and Analysis
    runs-on: ubuntu-latest
    needs: [environment-setup, sast-codeql, sast-sonarqube, sast-semgrep, sca-nuget, sca-dependencies, secret-scanning]
    if: always()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all security scan artifacts
        uses: actions/download-artifact@v4
        with:
          path: security-results/

      - name: Setup Python for analysis
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install vulnerability analysis tools
        run: |
          pip install -r .github/scripts/requirements.txt || true
          pip install sarif-tools || true

      - name: Aggregate and analyze vulnerabilities
        run: |
          python .github/scripts/vulnerability-aggregator.py \
            --input-dir security-results/ \
            --output-dir vulnerability-analysis/ \
            --severity-threshold ${{ github.event.inputs.severityThreshold || 'medium' }} \
            --generate-report

      - name: Create triage summary
        run: |
          python .github/scripts/generate-triage-summary.py \
            --input-dir vulnerability-analysis/ \
            --output-file triage-summary.md \
            --github-token ${{ secrets.GITHUB_TOKEN }} \
            --repo ${{ github.repository }}

      - name: Upload vulnerability analysis
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vulnerability-analysis-${{ needs.environment-setup.outputs.scan-id }}
          path: |
            vulnerability-analysis/
            triage-summary.md
          retention-days: 180

  # === SECURITY QUALITY GATES ===
  security-gate:
    name: Security Quality Gate
    runs-on: ubuntu-latest
    needs: [
      environment-setup, 
      sast-codeql, 
      sast-sonarqube, 
      sast-semgrep, 
      sca-nuget, 
      sca-dependencies, 
      secret-scanning,
      vulnerability-triage
    ]
    if: always() && (github.event_name == 'push' || github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-results/

      - name: Setup Python for gate evaluation
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install gate evaluation tools
        run: |
          pip install -r .github/scripts/requirements.txt || true

      - name: Evaluate security gates
        id: gate-evaluation
        run: |
          python .github/scripts/security-gate-evaluator.py \
            --scan-results all-results/ \
            --severity-threshold ${{ github.event.inputs.severityThreshold || 'medium' }} \
            --gate-policy .github/security/policies/gate-policy.json \
            --output-file gate-evaluation.json

          echo "gate-status=$(jq -r '.gate_status' gate-evaluation.json)" >> $GITHUB_OUTPUT
          echo "critical-issues=$(jq -r '.critical_issues' gate-evaluation.json)" >> $GITHUB_OUTPUT
          echo "high-issues=$(jq -r '.high_issues' gate-evaluation.json)" >> $GITHUB_OUTPUT

      - name: Create security gate summary
        run: |
          python .github/scripts/generate-security-summary.py \
            --gate-results gate-evaluation.json \
            --output-file security-summary.md \
            --github-step-summary

      - name: Fail build on critical security issues
        if: steps.gate-evaluation.outputs.gate-status == 'FAILED'
        run: |
          echo "‚ùå Security Gate Failed"
          echo "Critical Issues: ${{ steps.gate-evaluation.outputs.critical-issues }}"
          echo "High Issues: ${{ steps.gate-evaluation.outputs.high-issues }}"
          exit 1

      - name: Success - Security gate passed
        if: steps.gate-evaluation.outputs.gate-status == 'PASSED'
        run: |
          echo "‚úÖ Security Gate Passed"
          echo "No critical security vulnerabilities detected."

      - name: Upload gate evaluation results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gate-evaluation-${{ needs.environment-setup.outputs.scan-id }}
          path: |
            gate-evaluation.json
            security-summary.md
          retention-days: 180

  # === SECURITY REPORTING AND DASHBOARD ===
  security-reporting:
    name: Security Report Generation
    runs-on: ubuntu-latest
    needs: [
      environment-setup,
      sast-codeql,
      sast-sonarqube, 
      sast-semgrep,
      sca-nuget,
      sca-dependencies,
      secret-scanning,
      vulnerability-triage,
      security-gate
    ]
    if: always()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: final-results/

      - name: Setup environment for report generation
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install report generation dependencies
        run: |
          pip install -r .github/scripts/requirements.txt || true
          pip install jinja2 markdown pdfkit || true

      - name: Generate comprehensive security report
        run: |
          python .github/scripts/generate-security-dashboard.py \
            --scan-results final-results/ \
            --output-dir security-dashboard/ \
            --template-dir .github/security/templates/ \
            --format html,pdf,json

      - name: Upload security dashboard
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-dashboard-${{ needs.environment-setup.outputs.scan-id }}
          path: |
            security-dashboard/
          retention-days: 365

      - name: Deploy to GitHub Pages (main branch only)
        if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./security-dashboard
          publish_branch: gh-pages

      - name: Create security issue for findings
        if: needs.security-gate.result == 'failure' && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const results = JSON.parse(fs.readFileSync('final-results/gate-evaluation/gate-evaluation.json', 'utf8'));
            
            const title = `üîí Security Scan Issues Detected - ${new Date().toLocaleDateString()}`;
            const body = `
            ## Security Scan Results
            
            Automated security scan detected the following issues:
            
            - **Critical Issues**: ${results.critical_issues}
            - **High Issues**: ${results.high_issues}
            - **Medium Issues**: ${results.medium_issues}
            - **Low Issues**: ${results.low_issues}
            
            **Scan ID**: ${results.scan_id}
            **Timestamp**: ${results.timestamp}
            
            Please review the security findings in the workflow artifacts and take appropriate action.
            
            ### Next Steps
            1. Review the detailed vulnerability analysis
            2. Create pull requests for dependency updates
            3. Address code-level security issues
            4. Update security policies if needed
            
            This issue was automatically created by the TiXL security scanning pipeline.
            `;
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['security', 'vulnerability', 'automated']
            });
            
            console.log(`Created security issue #${issue.data.number}`);

  # === SECURITY NOTIFICATIONS ===
  security-notifications:
    name: Security Notifications
    runs-on: ubuntu-latest
    needs: [security-gate, security-reporting]
    if: always()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download security results
        uses: actions/download-artifact@v4
        with:
          name: security-dashboard-${{ needs.environment-setup.outputs.scan-id }}
          path: notification-data/

      - name: Send security notifications
        run: |
          python .github/scripts/security-notification-handler.py \
            --scan-results notification-data/ \
            --gate-result ${{ needs.security-gate.result }} \
            --webhook-url ${{ secrets.SECURITY_WEBHOOK_URL }} \
            --email-config ${{ secrets.EMAIL_CONFIG }} \
            --slack-config ${{ secrets.SLACK_CONFIG }}

      - name: Update security metrics
        if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        run: |
          python .github/scripts/update-security-metrics.py \
            --input-dir notification-data/ \
            --output-file .github/security/metrics/security-metrics.json