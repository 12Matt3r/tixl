# Enhanced TiXL GitHub Actions Workflow with Comprehensive Code Coverage
# Includes Coverlet integration, quality gates, and detailed reporting

name: TiXL CI/CD with Code Coverage

on:
  push:
    branches: [ main, develop, feature/*, coverage-* ]
  pull_request:
    branches: [ main, develop ]

env:
  DOTNET_VERSION: '9.0.x'
  SOLUTION_PATH: 'TiXL.sln'
  TEST_PROJECT_PATH: 'Tests/TiXL.Tests.csproj'
  COVERAGE_TIMEOUT: 600

jobs:
  build-and-test:
    name: Build, Test, and Coverage Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better analysis

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_PATH }}

    - name: Build solution
      run: |
        dotnet build ${{ env.SOLUTION_PATH }} \
          --configuration Release \
          --no-restore \
          /p:TreatWarningsAsErrors=true \
          /p:EnforceCodeStyleInBuild=true

    - name: Install ReportGenerator
      run: dotnet tool install --global ReportGenerator

    - name: Run tests with coverage collection
      shell: pwsh
      run: |
        Write-Host "Starting coverage analysis"
        
        # Run coverage analyzer
        & ./docs/scripts/coverage-analyzer.ps1 \
          -SolutionPath "${{ env.SOLUTION_PATH }}" \
          -TestProjectPath "${{ env.TEST_PROJECT_PATH }}" \
          -OutputPath "./coverage-reports" \
          -ConfigPath "./docs/config/coverage-thresholds.config" \
          -GenerateHTMLReport \
          -Verbose
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "Coverage analysis failed with exit code $LASTEXITCODE"
          exit $LASTEXITCODE
        }

    - name: Run coverage quality gate
      shell: pwsh
      run: |
        & ./docs/scripts/coverage-quality-gate.ps1 \
          -CoverageSummaryPath "./coverage-reports/coverage-summary.json" \
          -ConfigPath "./docs/config/coverage-thresholds.config" \
          -BaselineFile "./docs/config/coverage-baseline.json" \
          -FailOnRegressions \
          -GenerateGitHubComment
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "Coverage quality gate failed with exit code $LASTEXITCODE"
          exit $LASTEXITCODE
        }

    - name: Generate HTML coverage reports
      shell: pwsh
      run: |
        & ./docs/scripts/generate-coverage-report.ps1 \
          -CoveragePath "./coverage-reports" \
          -OutputPath "./coverage-reports/html-reports"

    - name: Upload coverage reports to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage-reports/coverage.cobertura.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

    - name: Archive coverage reports
      uses: actions/upload-artifact@v4
      with:
        name: coverage-reports
        path: ./coverage-reports/

    - name: Archive GitHub comment
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: github-coverage-comment
        path: ./coverage-reports/github-coverage-comment.md

  security-scan:
    name: Security and Vulnerability Scan
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Run dependency vulnerability scan
      shell: pwsh
      run: |
        & ./docs/scripts/vulnerability-scanner.ps1 \
          -ProjectPath "${{ env.SOLUTION_PATH }}" \
          -OutputPath "./security-reports" \
          -Severity "Medium" \
          -FailOnCritical

    - name: Upload security reports
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: ./security-reports/

  performance-tests:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Build benchmarks
      run: |
        dotnet build Benchmarks/TiXL.Benchmarks.csproj \
          --configuration Release \
          --no-restore

    - name: Run benchmarks
      run: |
        dotnet run --project Benchmarks/TiXL.Benchmarks.csproj \
          --configuration Release \
          -- --job short --benchmarkdotnet

    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-results
        path: BenchmarkDotNet.Artifacts/

  package:
    name: Create NuGet Packages
    runs-on: ubuntu-latest
    needs: [build-and-test, security-scan]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_PATH }}

    - name: Build for packaging
      run: |
        dotnet build ${{ env.SOLUTION_PATH }} \
          --configuration Release \
          --no-restore

    - name: Pack NuGet packages
      run: |
        dotnet pack ${{ env.SOLUTION_PATH }} \
          --configuration Release \
          --no-build \
          --output ./nupkgs \
          /p:GenerateDocumentationFile=true

    - name: Upload NuGet packages
      uses: actions/upload-artifact@v4
      with:
        name: nuget-packages
        path: ./nupkgs/

  quality-gate:
    name: Comprehensive Quality Gate
    runs-on: ubuntu-latest
    needs: [build-and-test, security-scan, performance-tests]
    if: always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Run comprehensive quality gate
      shell: pwsh
      run: |
        & ./docs/scripts/comprehensive-quality-gate.ps1 \
          -BuildPath "./" \
          -CoveragePath "./coverage-reports" \
          -ConfigPath "./docs/config" \
          -GenerateReport \
          -FailOnQualityIssues

    - name: Upload quality reports
      uses: actions/upload-artifact@v4
      with:
        name: quality-reports
        path: ./quality-analysis/

  publish-coverage-summary:
    name: Publish Coverage Summary
    runs-on: ubuntu-latest
    needs: [build-and-test]
    if: always()
    
    steps:
    - name: Download coverage reports
      uses: actions/download-artifact@v4
      with:
        name: coverage-reports
        path: ./coverage-reports

    - name: Publish coverage summary to PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          try {
            // Read the coverage summary
            const summaryPath = './coverage-reports/coverage-summary.json';
            if (fs.existsSync(summaryPath)) {
              const summary = JSON.parse(fs.readFileSync(summaryPath, 'utf8'));
              const commentPath = './coverage-reports/github-coverage-comment.md';
              
              if (fs.existsSync(commentPath)) {
                const comment = fs.readFileSync(commentPath, 'utf8');
                
                // Post comment to PR
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: comment
                });
              }
            }
          } catch (error) {
            console.log('Error posting coverage comment:', error);
          }

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-and-test, security-scan, performance-tests, package, quality-gate]
    if: |
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push' &&
      needs.build-and-test.result == 'success' &&
      needs.security-scan.result == 'success' &&
      needs.performance-tests.result == 'success' &&
      needs.package.result == 'success' &&
      needs.quality-gate.result == 'success'
    
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download NuGet packages
      uses: actions/download-artifact@v4
      with:
        name: nuget-packages
        path: ./nupkgs

    - name: Publish to NuGet.org
      env:
        NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
      run: |
        for nupkg in ./nupkgs/*.nupkg; do
          echo "Publishing $nupkg"
          dotnet nuget push "$nupkg" --api-key "$NUGET_API_KEY" --source https://api.nuget.org/v3/index.json --skip-duplicate
        done

  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [build-and-test, security-scan, performance-tests, package, quality-gate, deploy]
    if: always()
    
    steps:
    - name: Notify team on failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const failureJobs = [
            'build-and-test',
            'security-scan', 
            'performance-tests',
            'package',
            'quality-gate',
            'deploy'
          ].filter(job => needs[job].result === 'failure');
          
          if (failureJobs.length > 0) {
            // Send notification about failed jobs
            console.log('Failed jobs:', failureJobs);
          }

    - name: Notify team on success
      if: success()
      uses: actions/github-script@v7
      with:
        script: |
          console.log('Build pipeline completed successfully!');
          
          // Create a summary comment on the commit
          const summary = `
          ðŸŽ‰ **TiXL Build Pipeline Completed Successfully**
          
          **Build Details:**
          - Branch: ${{ github.ref_name }}
          - Commit: ${{ github.sha.substring(0, 8) }}
          - Workflow: ${{ github.run_id }}
          
          **Quality Metrics:**
          âœ… Code Coverage Analysis
          âœ… Security Scanning
          âœ… Performance Testing
          âœ… Quality Gates
          âœ… Package Generation
          
          All quality standards have been met!
          `;
          
          // Note: In a real implementation, you would send this to your team's communication channels